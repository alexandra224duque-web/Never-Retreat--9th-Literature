<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Never Retreat - ESL Literature Module</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Global Anti-Cheat Styles */
        body {
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
        }
        
        /* Allow selection in input fields */
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        /* Reading Tab Specifics */
        .allow-select {
            -webkit-user-select: text !important;
            user-select: text !important;
            cursor: text;
        }

        .word-trigger {
            color: #1d4ed8; /* blue-700 */
            font-weight: 700;
            border-bottom: 2px solid #bfdbfe; /* blue-200 */
            cursor: pointer;
            padding: 0 2px;
            border-radius: 2px;
            transition: background-color 0.2s;
        }
        
        .word-trigger:hover {
            background-color: #eff6ff; /* blue-50 */
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .popover-arrow {
            width: 0; 
            height: 0; 
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #1e293b;
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- DATA CONSTANTS ---

        const VOCAB_DATA = [
            {
                word: "Combustion",
                def: "The process of burning something to produce heat/energy.",
                example: "The combustion of fossil fuels releases gases.",
                ccqs: ["Does this create heat?", "Does it happen without fire/burning?"],
                answers: ["Yes", "No"]
            },
            {
                word: "Scarcity",
                def: "When there is not enough of something for everyone.",
                example: "The scarcity of water is a big problem in deserts.",
                ccqs: ["Is there a lot of the item?", "Can scarcity make prices go up?"],
                answers: ["No", "Yes"]
            },
            {
                word: "Aquifer",
                def: "Underground rock that holds water.",
                example: "Farmers pump water from the aquifer for their crops.",
                ccqs: ["Is this water found in the sky?", "Can an aquifer run out of water?"],
                answers: ["No", "Yes"]
            },
            {
                word: "Ingenuity",
                def: "Being clever and inventive to solve problems.",
                example: "Using a paperclip to unlock the door showed great ingenuity.",
                ccqs: ["Is this about being lazy?", "Does it involve solving problems?"],
                answers: ["No", "Yes"]
            },
            {
                word: "Windfall",
                def: "A large, unexpected gain or benefit.",
                example: "Winning the lottery was a huge windfall for the family.",
                ccqs: ["Is a windfall usually bad news?", "Did you expect it to happen?"],
                answers: ["No", "No"]
            },
            {
                word: "Rationed",
                def: "Limited so each person gets only a small amount.",
                example: "During the war, sugar and gasoline were rationed.",
                ccqs: ["Can you buy as much as you want?", "Is this common in emergencies?"],
                answers: ["No", "Yes"]
            },
            {
                word: "Decentralization",
                def: "Spreading power to many places instead of one center.",
                example: "Decentralization gives local towns more control.",
                ccqs: ["Is one person in total control?", "Does it make systems more flexible?"],
                answers: ["No", "Yes"]
            },
            {
                word: "Resilience",
                def: "Ability to recover quickly from difficult situations.",
                example: "The city showed resilience by rebuilding after the storm.",
                ccqs: ["Do resilient people give up easily?", "Does it help you adapt?"],
                answers: ["No", "Yes"]
            }
        ];

        const QUIZ_QUESTIONS = [
            {
                id: "q1",
                type: "mcq",
                text: "PART A: What is a main claim the author makes in 'Never Retreat'?",
                options: [
                    { id: "A", text: "Nations will hurt their economies by being connected." },
                    { id: "B", text: "Nations usually work together on problems." },
                    { id: "C", text: "People want to keep their comfortable lifestyle, even if they should cut back." },
                    { id: "D", text: "Governments must lead the way, not individuals." }
                ],
                correct: "C",
                explanation: "The author argues that people are addicted to convenience and find it painful to 'climb down the ladder' of lifestyle standards."
            },
            {
                id: "q2",
                type: "mcq",
                text: "PART B: Which sentence supports the answer to Part A?",
                options: [
                    { id: "A", text: "'Energy buys convenience.' (paragraph 4)" },
                    { id: "B", text: "'Bluefin tuna is in steep decline...' (paragraph 6)" },
                    { id: "C", text: "'Using less energy... would make the West’s transition... easier.' (paragraph 8)" },
                    { id: "D", text: "'Real-world Americans experienced a downshift...' (paragraph 12)" }
                ],
                correct: "A",
                explanation: "This quote supports the idea that our lifestyle relies on energy and we are attached to that convenience."
            },
            {
                id: "q3",
                type: "text",
                text: "In paragraph 4, the author compares our dependence on convenience to an addiction. Why does he use this comparison?",
                correctKeywords: ["addict", "habit", "stop", "difficult", "hard"],
                explanation: "He compares it to addiction (using words like 'dosage') to show that it is extremely difficult for people to stop using energy, even if they know they should."
            },
            {
                id: "q4",
                type: "text",
                text: "EVALUATE: What does the author say is the main difficulty in ending our dependence on fossil fuels? (Cite evidence)",
                correctKeywords: ["lifestyle", "standard", "living", "comfort", "convenience"],
                explanation: "The main difficulty is that people do not want to lower their standard of living. The text says resistance to a 'downshift in lifestyle is strong'."
            }
        ];

        // --- COMPONENTS ---

        const IconWarning = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        );

        const IconHighlighter = () => (
             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 11-6 6v3h9l3-3"/><path d="m22 2-7 7 4 4 7-7"/><path d="m18 22 4-4"/></svg>
        );

        const IconTrash = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
        );

        // 1. VOCABULARY TAB
        const VocabularyTab = ({ activeTab }) => {
            const [selectedWord, setSelectedWord] = useState(null);
            const [selectedDef, setSelectedDef] = useState(null);
            const [matches, setMatches] = useState({});
            const [wrong, setWrong] = useState(false);

            const handleWordClick = (word) => {
                if (matches[word]) return;
                setSelectedWord(word);
                setWrong(false);
                checkMatch(word, selectedDef);
            };

            const handleDefClick = (defWord) => {
                if (matches[defWord]) return;
                setSelectedDef(defWord);
                setWrong(false);
                checkMatch(selectedWord, defWord);
            };

            const checkMatch = (w, d) => {
                if (w && d) {
                    if (w === d) {
                        setMatches(prev => ({ ...prev, [w]: true }));
                        setSelectedWord(null);
                        setSelectedDef(null);
                    } else {
                        setWrong(true);
                        setTimeout(() => {
                            setSelectedWord(null);
                            setSelectedDef(null);
                            setWrong(false);
                        }, 1000);
                    }
                }
            };

            const [shuffledDefs, setShuffledDefs] = useState([]);
            useEffect(() => {
                setShuffledDefs([...VOCAB_DATA].sort(() => Math.random() - 0.5));
            }, []);

            return (
                <div className="max-w-4xl mx-auto pb-20">
                    <h2 className="text-2xl font-bold text-slate-800 mb-6 border-b pb-2">1. Vocabulary Study</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
                        {VOCAB_DATA.map((item, idx) => (
                            <div key={idx} className="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                                <h3 className="text-xl font-bold text-blue-700 mb-2">{item.word}</h3>
                                <p className="italic text-slate-600 mb-2">{item.def}</p>
                                <p className="text-sm bg-slate-50 p-2 rounded mb-4 text-slate-700">"{item.example}"</p>
                                <div className="border-t pt-3">
                                    <p className="text-xs font-bold text-slate-400 uppercase tracking-wide mb-2">Check your understanding:</p>
                                    <ul className="text-sm space-y-1">
                                        <li className="flex items-center gap-2">
                                            <span className="w-1 h-1 bg-slate-400 rounded-full"></span>
                                            {item.ccqs[0]}
                                        </li>
                                        <li className="flex items-center gap-2">
                                            <span className="w-1 h-1 bg-slate-400 rounded-full"></span>
                                            {item.ccqs[1]}
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        ))}
                    </div>

                    <h2 className="text-2xl font-bold text-slate-800 mb-6 border-b pb-2">2. Match the Meaning</h2>
                    <p className="mb-4 text-slate-600">Tap a word (blue), then tap its definition (orange) to match them.</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div className="space-y-3">
                            {VOCAB_DATA.map((item) => (
                                <button
                                    key={item.word}
                                    onClick={() => handleWordClick(item.word)}
                                    className={`w-full p-4 text-left rounded-lg border transition-all duration-200 
                                        ${matches[item.word] ? 'bg-green-100 border-green-500 text-green-800 opacity-50 cursor-default' : 
                                          selectedWord === item.word ? 'bg-blue-600 text-white border-blue-600 shadow-md transform scale-105' : 
                                          'bg-white border-slate-300 hover:border-blue-400 hover:bg-blue-50'}`}
                                >
                                    {item.word} {matches[item.word] && "✓"}
                                </button>
                            ))}
                        </div>
                        <div className="space-y-3">
                            {shuffledDefs.map((item) => (
                                <button
                                    key={item.word}
                                    onClick={() => handleDefClick(item.word)}
                                    className={`w-full p-4 text-left rounded-lg border transition-all duration-200 text-sm
                                        ${matches[item.word] ? 'bg-green-100 border-green-500 text-green-800 opacity-50 cursor-default' : 
                                          selectedDef === item.word ? 'bg-orange-500 text-white border-orange-500 shadow-md transform scale-105' : 
                                          'bg-white border-slate-300 hover:border-orange-400 hover:bg-orange-50'}`}
                                >
                                    {item.def} {matches[item.word] && "✓"}
                                </button>
                            ))}
                        </div>
                    </div>
                    {wrong && (
                        <div className="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-2 rounded-full shadow-lg animate-fade-in z-50">
                            Try Again! Not a match.
                        </div>
                    )}
                </div>
            );
        };

        // 2. READING TAB (Refactored for Highlighting)
        
        // Helper to generate HTML for clickable words
        const createWord = (text, def, synonym) => {
            return `<span class="word-trigger" data-def="${def}" data-syn="${synonym}" data-word="${text}">${text}</span>`;
        };

        const READING_CONTENT_HTML = `
            <div class="mb-4">
                <span class="font-bold text-slate-400 mr-2">1</span>
                Our dependence on fossil fuels didn’t arise from an evil plot but through our curiosity and ${createWord("ingenuity", "cleverness in solving problems", "creativity")}. Coal was seen only as a heat source until we found it could power steam engines. Later we discovered that the gas it gave off when heated could light homes and streets. Gasoline was considered a useless by-product of petroleum—and then came the internal ${createWord("combustion", "burning to create energy", "burning")} engine.
            </div>
            <div class="mb-4">
                <span class="font-bold text-slate-400 mr-2">2</span>
                Necessity is said to be the mother of invention, but the reverse is also true. We tinker and probe, then see if our discovery fills any need, including needs we didn’t know we had.
            </div>
            <div class="mb-4">
                <span class="font-bold text-slate-400 mr-2">3</span>
                With fossil fuels, new uses multiplied madly until we wove them into every corner of our lives. What used to be luxuries—garage-door openers, dishwashers, cell phones—came to feel like necessities. It’s easy to go up the lifestyle ladder but painful climbing down. This is important.
            </div>
            <div class="mb-4">
                <span class="font-bold text-slate-400 mr-2">4</span>
                It’s not hard to understand. The ${createWord("windfall", "unexpected large benefit", "lucky bonus")} of cheap fossil fuels that’s fueled the West for two centuries got us used to ever-rising living standards. Energy buys convenience. And convenience is addictive—highly so. Each increased dosage quickly becomes our new minimum requirement. You see this whenever gas prices rise and endanger our freedom to drive as much as we want.
            </div>
            <div class="mb-4">
                <span class="font-bold text-slate-400 mr-2">5</span>
                To escape from the environmental crunch, we don’t need to throw out our entire lifestyle but simply to power it on something other than fossil fuels. We’re on the way. Switching to renewables for electricity is probably the easy part. Harder will be getting oil out of transportation and agriculture and the military. Can we run this film in reverse?
            </div>
            <div class="mb-4">
                <span class="font-bold text-slate-400 mr-2">6</span>
                When our standard of living is threatened by ${createWord("scarcity", "not having enough resources", "shortage")} and side effects, you’d think we’d cut back. Instead, the common response is to maintain it at any cost. Bluefin tuna is in steep decline, but the tuna-loving Japanese are catching all they can. We know our freshwater ${createWord("aquifers", "underground water sources", "groundwater")} are limited, but we’re draining them faster rather than slower.
            </div>
            <div class="mb-4">
                <span class="font-bold text-slate-400 mr-2">7</span>
                Developing countries feel the same. People getting their first paved roads, safe water, electric lights, and refrigerators don’t want to march backward any more than the West does.
            </div>
            <div class="mb-4">
                <span class="font-bold text-slate-400 mr-2">8</span>
                Using less energy and consuming less—taking a step down the ladder—would make the West’s transition to renewables that much easier. The call “Never retreat” comes from us both as consumers and breadwinners.
            </div>
            <div class="mb-4">
                <span class="font-bold text-slate-400 mr-2">9</span>
                Many have sketched a sustainable economy that doesn’t rest on unnecessary consumption. These proposals often favor ${createWord("decentralization", "spreading out power/control", "spreading out")}—a more dispersed and rural society. This would give us an economy with greater ${createWord("resilience", "ability to recover quickly", "toughness")} than our current highly connected one.
            </div>
            <div class="mb-4">
                <span class="font-bold text-slate-400 mr-2">12</span>
                What might a major lifestyle downshift feel like? Real-world Americans experienced a downshift during World War II. Gasoline, milk, meat, coffee, cheese, sugar, heating oil, and shoes were strictly ${createWord("rationed", "limited to a fixed amount", "restricted")}. Could we do it again?
            </div>
             <div class="mb-4">
                <span class="font-bold text-slate-400 mr-2">13</span>
                Adaptability is one of humankind’s hallmarks. We evolved during difficult climatic times. Is that ability to adapt still within us?
            </div>
        `;

        const ReadingTab = () => {
            const [highlightMode, setHighlightMode] = useState(false);
            const [popup, setPopup] = useState(null); // { x, y, word, def, syn }
            const textContainerRef = useRef(null);

            // Handle Definition Clicks (Delegation)
            const handleContainerClick = (e) => {
                // If clicking a word trigger
                const trigger = e.target.closest('.word-trigger');
                if (trigger) {
                    const rect = trigger.getBoundingClientRect();
                    setPopup({
                        x: rect.left + (rect.width / 2),
                        y: rect.top,
                        word: trigger.dataset.word,
                        def: trigger.dataset.def,
                        syn: trigger.dataset.syn
                    });
                    e.stopPropagation();
                    return;
                }
                
                // Close popup if clicking elsewhere
                setPopup(null);
            };

            // Handle Highlighting Logic
            const handleMouseUp = () => {
                if (!highlightMode) return;

                const selection = window.getSelection();
                if (selection && selection.toString().length > 0) {
                    // Use document.execCommand to handle complex overlapping tags safely
                    // This works because the container is contentEditable
                    document.execCommand("hiliteColor", false, "#fef08a"); // yellow-200
                    
                    // Clear selection after highlighting
                    selection.removeAllRanges();
                }
            };

            const clearHighlights = () => {
                if (window.confirm("Remove all highlights?")) {
                    // Reset content
                     if (textContainerRef.current) {
                        textContainerRef.current.innerHTML = READING_CONTENT_HTML;
                     }
                }
            };

            return (
                <div className="max-w-3xl mx-auto pb-24 text-lg leading-relaxed text-slate-700 relative">
                    {/* Toolbar */}
                    <div className="sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-slate-200 p-2 mb-4 rounded-lg shadow-sm flex items-center justify-between gap-2">
                        <div className="flex items-center gap-2">
                            <span className="text-sm font-bold text-slate-500 uppercase tracking-wide mr-2">Tools:</span>
                            <button 
                                onClick={() => setHighlightMode(!highlightMode)}
                                className={`flex items-center gap-2 px-3 py-1.5 rounded text-sm font-bold transition-colors ${highlightMode ? 'bg-yellow-100 text-yellow-800 border border-yellow-300' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                            >
                                <IconHighlighter />
                                {highlightMode ? "Highlighter ON" : "Highlighter OFF"}
                            </button>
                            {highlightMode && <span className="text-xs text-yellow-700 animate-fade-in">Select text to highlight</span>}
                        </div>
                        <button 
                            onClick={clearHighlights}
                            className="p-2 text-slate-400 hover:text-red-500 transition-colors"
                            title="Clear Highlights"
                        >
                            <IconTrash />
                        </button>
                    </div>

                    <div className="bg-white p-8 sm:p-12 shadow-sm border rounded-xl relative">
                        <h1 className="text-3xl font-bold text-slate-900 mb-2">Never Retreat</h1>
                        <p className="text-slate-500 mb-8 font-serif italic">From Eyes Wide Open • Argument by Paul Fleischman</p>
                        
                        {/* Text Container */}
                        <div 
                            ref={textContainerRef}
                            className={`outline-none ${highlightMode ? 'allow-select' : ''}`}
                            contentEditable={highlightMode}
                            suppressContentEditableWarning={true}
                            onMouseUp={handleMouseUp}
                            onClick={handleContainerClick}
                            onKeyDown={(e) => e.preventDefault()} // Read-only
                            onPaste={(e) => e.preventDefault()} // No pasting
                            dangerouslySetInnerHTML={{ __html: READING_CONTENT_HTML }}
                        ></div>

                        {/* Definition Popover */}
                        {popup && (
                            <div 
                                className="fixed z-50 bg-slate-800 text-white text-sm p-4 rounded-lg shadow-xl animate-fade-in w-64 pointer-events-auto"
                                style={{ 
                                    left: popup.x, 
                                    top: popup.y - 10,
                                    transform: 'translate(-50%, -100%)'
                                }}
                            >
                                <p className="font-bold mb-1 text-blue-300 text-lg">{popup.word}</p>
                                <p className="mb-2 text-slate-200">{popup.def}</p>
                                <div className="pt-2 border-t border-slate-700">
                                    <span className="text-xs text-slate-400 italic uppercase mr-2">Synonym:</span>
                                    <span className="text-yellow-200 font-medium">{popup.syn}</span>
                                </div>
                                <div className="popover-arrow"></div>
                                <button onClick={(e) => { e.stopPropagation(); setPopup(null); }} className="absolute top-1 right-2 text-slate-400 hover:text-white text-lg leading-none">×</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 3. EXERCISES TAB & CANVAS LOGIC
        const ExercisesTab = () => {
            const [student, setStudent] = useState({ fname: "", lname: "" });
            const [answers, setAnswers] = useState({});
            const [submitting, setSubmitting] = useState(false);

            const handleChange = (qId, val) => {
                setAnswers(prev => ({ ...prev, [qId]: val }));
            };

            const downloadReport = async () => {
                if(!student.fname || !student.lname) {
                    alert("Please enter your name first.");
                    return;
                }
                
                setSubmitting(true);
                
                // CANVAS GENERATION LOGIC
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const width = 800;
                let height = 300 + (QUIZ_QUESTIONS.length * 250); 
                canvas.width = width;
                canvas.height = height;

                // Background
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(0, 0, width, height);

                // Header
                ctx.fillStyle = "#1e293b"; // Slate-800
                ctx.fillRect(0, 0, width, 120);
                
                ctx.fillStyle = "#ffffff";
                ctx.font = "bold 32px Arial";
                ctx.fillText("Comprehension Report", 40, 50);
                ctx.font = "24px Arial";
                ctx.fillText(`${student.fname} ${student.lname}`, 40, 90);
                
                const date = new Date().toLocaleDateString();
                ctx.textAlign = "right";
                ctx.fillText(date, width - 40, 90);
                ctx.textAlign = "left";

                // Content Loop
                let y = 160;
                
                const wrapText = (text, x, y, maxWidth, lineHeight) => {
                    const words = text.split(' ');
                    let line = '';
                    for(let n = 0; n < words.length; n++) {
                        const testLine = line + words[n] + ' ';
                        const metrics = ctx.measureText(testLine);
                        const testWidth = metrics.width;
                        if (testWidth > maxWidth && n > 0) {
                            ctx.fillText(line, x, y);
                            line = words[n] + ' ';
                            y += lineHeight;
                        } else {
                            line = testLine;
                        }
                    }
                    ctx.fillText(line, x, y);
                    return y + lineHeight;
                }

                QUIZ_QUESTIONS.forEach((q, index) => {
                    const studentAns = answers[q.id] || "No Answer";
                    const isCorrect = q.type === 'mcq' ? studentAns === q.correct : "Manual Review";
                    
                    ctx.fillStyle = "#f1f5f9"; // Slate-100
                    ctx.fillRect(40, y, width - 80, 40);
                    ctx.fillStyle = "#334155";
                    ctx.font = "bold 18px Arial";
                    ctx.fillText(`Q${index + 1}: ${q.type.toUpperCase()}`, 50, y + 26);
                    y += 60;

                    ctx.fillStyle = "#000000";
                    ctx.font = "16px Arial";
                    y = wrapText(q.text, 40, y, 720, 24);
                    y += 10;

                    ctx.font = "bold 16px Arial";
                    if (q.type === 'mcq') {
                        ctx.fillStyle = isCorrect ? "#16a34a" : "#dc2626"; 
                        ctx.fillText(`Your Answer: ${studentAns} ${isCorrect ? '(Correct)' : '(Incorrect)'}`, 40, y);
                    } else {
                        ctx.fillStyle = "#2563eb"; 
                        ctx.fillText(`Your Answer:`, 40, y);
                        y += 25;
                        ctx.font = "italic 16px Arial";
                        y = wrapText(studentAns, 40, y, 720, 24);
                    }
                    y += 30;

                    ctx.fillStyle = "#475569";
                    ctx.font = "14px Arial";
                    ctx.fillText("Feedback / Correct Answer:", 40, y);
                    y += 20;
                    y = wrapText(q.explanation, 40, y, 720, 20);
                    
                    y += 40; 
                });

                const dataUrl = canvas.toDataURL("image/png");
                const link = document.createElement('a');
                link.download = `${student.lname}_Report.png`;
                link.href = dataUrl;
                link.click();
                
                setSubmitting(false);
            };

            return (
                <div className="max-w-3xl mx-auto pb-24">
                    <div className="bg-blue-50 border border-blue-200 p-6 rounded-lg mb-8">
                        <h3 className="font-bold text-blue-800 mb-4">Student Identification</h3>
                        <div className="flex gap-4">
                            <div className="flex-1">
                                <label className="block text-sm text-blue-900 mb-1">First Name</label>
                                <input 
                                    type="text" 
                                    className="w-full p-2 border rounded"
                                    value={student.fname}
                                    onChange={(e) => setStudent({...student, fname: e.target.value})}
                                />
                            </div>
                            <div className="flex-1">
                                <label className="block text-sm text-blue-900 mb-1">Last Name</label>
                                <input 
                                    type="text" 
                                    className="w-full p-2 border rounded"
                                    value={student.lname}
                                    onChange={(e) => setStudent({...student, lname: e.target.value})}
                                />
                            </div>
                        </div>
                    </div>

                    <div className="space-y-8">
                        {QUIZ_QUESTIONS.map((q, idx) => (
                            <div key={q.id} className="bg-white p-6 rounded-lg shadow border border-slate-200">
                                <span className="text-xs font-bold text-slate-400 uppercase">Question {idx + 1}</span>
                                <p className="font-bold text-slate-800 text-lg mb-4">{q.text}</p>
                                
                                {q.type === 'mcq' ? (
                                    <div className="space-y-2">
                                        {q.options.map(opt => (
                                            <label key={opt.id} className="flex items-start gap-3 p-3 rounded hover:bg-slate-50 border border-transparent hover:border-slate-200 cursor-pointer">
                                                <input 
                                                    type="radio" 
                                                    name={q.id} 
                                                    value={opt.id}
                                                    checked={answers[q.id] === opt.id}
                                                    onChange={() => handleChange(q.id, opt.id)}
                                                    className="mt-1"
                                                />
                                                <span className="text-slate-700">{opt.text}</span>
                                            </label>
                                        ))}
                                    </div>
                                ) : (
                                    <textarea 
                                        className="w-full border rounded p-3 text-slate-700 h-32 focus:ring-2 focus:ring-blue-500 outline-none"
                                        placeholder="Type your answer here..."
                                        value={answers[q.id] || ""}
                                        onChange={(e) => handleChange(q.id, e.target.value)}
                                    ></textarea>
                                )}
                            </div>
                        ))}
                    </div>

                    <div className="mt-12 text-center">
                        <button 
                            onClick={downloadReport}
                            disabled={submitting}
                            className="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-lg shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2 mx-auto"
                        >
                            {submitting ? "Generating..." : "Download Report Image"}
                        </button>
                        <p className="mt-4 text-sm text-slate-500">
                            Check all answers before downloading. A PNG image will be saved to your device.
                        </p>
                    </div>
                </div>
            );
        };

        // --- MAIN APP SHELL ---

        const App = () => {
            const [activeTab, setActiveTab] = useState('vocabulary');
            const [cheating, setCheating] = useState(false);

            useEffect(() => {
                const handleVisibilityChange = () => {
                    if (document.hidden) {
                        setCheating(true);
                    }
                };

                const preventDefault = (e) => e.preventDefault();

                document.addEventListener("visibilitychange", handleVisibilityChange);
                document.addEventListener("contextmenu", preventDefault);
                document.addEventListener("copy", preventDefault);
                document.addEventListener("paste", preventDefault);
                document.addEventListener("cut", preventDefault);

                return () => {
                    document.removeEventListener("visibilitychange", handleVisibilityChange);
                    document.removeEventListener("contextmenu", preventDefault);
                    document.removeEventListener("copy", preventDefault);
                    document.removeEventListener("paste", preventDefault);
                    document.removeEventListener("cut", preventDefault);
                };
            }, []);

            return (
                <div className="h-full flex flex-col bg-slate-100">
                    <header className="bg-slate-900 text-white p-4 shadow-md z-10">
                        <div className="max-w-5xl mx-auto flex items-center justify-between">
                            <h1 className="text-xl font-bold tracking-tight">Grade 9 ESL: Never Retreat</h1>
                            <span className="text-xs bg-slate-800 px-2 py-1 rounded text-slate-400">Secure Mode Active</span>
                        </div>
                    </header>

                    <nav className="bg-white border-b border-slate-200">
                        <div className="max-w-5xl mx-auto flex">
                            <button 
                                onClick={() => setActiveTab('vocabulary')}
                                className={`flex-1 py-4 text-sm font-bold uppercase tracking-wide border-b-4 transition-colors
                                    ${activeTab === 'vocabulary' ? 'border-blue-600 text-blue-700 bg-blue-50' : 'border-transparent text-slate-500 hover:text-slate-700'}`}
                            >
                                1. Vocabulary
                            </button>
                            <button 
                                onClick={() => setActiveTab('reading')}
                                className={`flex-1 py-4 text-sm font-bold uppercase tracking-wide border-b-4 transition-colors
                                    ${activeTab === 'reading' ? 'border-blue-600 text-blue-700 bg-blue-50' : 'border-transparent text-slate-500 hover:text-slate-700'}`}
                            >
                                2. Reading
                            </button>
                            <button 
                                onClick={() => setActiveTab('exercises')}
                                className={`flex-1 py-4 text-sm font-bold uppercase tracking-wide border-b-4 transition-colors
                                    ${activeTab === 'exercises' ? 'border-blue-600 text-blue-700 bg-blue-50' : 'border-transparent text-slate-500 hover:text-slate-700'}`}
                            >
                                3. Exercises
                            </button>
                        </div>
                    </nav>

                    <main className="flex-1 overflow-y-auto p-4 md:p-8">
                        <div className="max-w-5xl mx-auto h-full">
                            {activeTab === 'vocabulary' && <VocabularyTab />}
                            {activeTab === 'reading' && <ReadingTab />}
                            {activeTab === 'exercises' && <ExercisesTab />}
                        </div>
                    </main>

                    {cheating && (
                        <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white rounded-xl p-8 max-w-md w-full text-center shadow-2xl">
                                <div className="flex justify-center mb-4 text-red-500">
                                    <IconWarning />
                                </div>
                                <h2 className="text-2xl font-bold text-slate-900 mb-2">Focus Warning</h2>
                                <p className="text-slate-600 mb-6">
                                    You left the activity window. Please stay on this tab to complete your assignment.
                                </p>
                                <button 
                                    onClick={() => setCheating(false)}
                                    className="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-lg transition-colors"
                                >
                                    I Understand, Return to Activity
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
